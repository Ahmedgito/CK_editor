/*
 *             Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
import{io}from'socket.io-client';import _0x4304c from'url-parse';import{ObservableMixin,priorities,global}from'ckeditor5/src/utils.js';import _0x5b0b27 from'./channel.js';import _0x24d1bb from'./../users/user.js';import _0x536af9 from'./../version.js';import _0x1c0920 from'./../ckeditorcloudserviceserror.js';import _0xef3092 from'./../ckeditorcloudservicesservererror.js';import{Encoder,Decoder}from'./parser/parser.js';import _0x3554e2 from'./requestsmanager.js';export const WEB_SOCKET_GATEWAY_STATES={'DISCONNECTED':'disconnected','CONNECTING':'connecting','CONNECTED':'connected'};class WebSocketGateway extends/* #__PURE__ -- @preserve */
ObservableMixin(){['_requestsManager'];['_url'];['_socket'];['_socketAuth'];['_channels'];['_connectionAttempt']=0x0;['_token'];['_options'];['_connectionProvider'];['_userFactory'];static ['STATE_DISCONNECTED']=/* #__PURE__ -- @preserve */
((()=>WEB_SOCKET_GATEWAY_STATES['DISCONNECTED'])());static ['STATE_CONNECTING']=/* #__PURE__ -- @preserve */
((()=>WEB_SOCKET_GATEWAY_STATES['CONNECTING'])());static ['STATE_CONNECTED']=/* #__PURE__ -- @preserve */
((()=>WEB_SOCKET_GATEWAY_STATES['CONNECTED'])());static ['_CHANGE_STATE_EVENT_PRIORITY']=/* #__PURE__ -- @preserve */
((()=>priorities['get']('highest')+0xf423f)());constructor(_0x3a4861,_0x87baa9,_0x460a2e,_0xf2c00c,_0xaf9826){if(super(),this['_token']=_0x87baa9,this['_options']=_0x460a2e??{},this['_connectionProvider']=_0xf2c00c??io,this['_userFactory']=_0xaf9826??_0x24d1bb['get'],this['_requestsManager']=new _0x3554e2(this),this['_channels']=new Map(),!_0x3a4861)throw new TypeError('Api\x20address\x20must\x20be\x20provided.');if(!this['_token'])throw new TypeError('Token\x20must\x20be\x20provided.');this['_options']['requestTimeout']||(this['_options']['requestTimeout']=0x4e20),this['_url']=_0x4304c(_0x3a4861['replace'](/^(?!(?:\w+:)?\/\/)/,'https://')),this['set']('state',WEB_SOCKET_GATEWAY_STATES['DISCONNECTED']),this['set']('socketId',void 0x0),this['set']('me',void 0x0),this['on']('change:state',async(_0x482425,_0x2fab2b,_0x5849ea)=>{if(this['_debugEvent']('ws-gw:change:state',_0x5849ea),_0x5849ea!==WebSocketGateway['STATE_CONNECTED']){if(_0x5849ea===WebSocketGateway['STATE_DISCONNECTED'])return this['_requestsManager']['errorAll'](new _0x1c0920('Not\x20connected.',this));}else try{this['me']=await this['_userFactory']['call'](_0x24d1bb,this,this['_socketAuth']?.['userId']);}catch(_0x315bc5){}},{'priority':WebSocketGateway['_CHANGE_STATE_EVENT_PRIORITY']}),this['on']('error',(_0x41b29d,_0x264db6)=>{this['_options']['onError']?this['_options']['onError'](_0x264db6):console['error'](_0x264db6);});}get['sessionId'](){return this['socketId'];}['waitForAllRequests'](_0x33f9ef){return this['_requestsManager']['waitForAllRequests'](_0x33f9ef);}['disconnect'](){this['state']!==WEB_SOCKET_GATEWAY_STATES['DISCONNECTED']&&(this['_socket']?.['disconnect'](),this['_socket']=void 0x0,this['state']=WEB_SOCKET_GATEWAY_STATES['DISCONNECTED']);}async['reconnect'](){this['_socket']||this['state']!==WEB_SOCKET_GATEWAY_STATES['DISCONNECTED']||(await this['_token']['refreshToken'](),await this['_connect']());}static async['connect'](_0x2ca458,_0x38935a='local.cs.dev:443/ws-v2',_0x3e803a={},_0x5bc88d=io,_0x314f59=_0x24d1bb['get']){const _0x19816d=new WebSocketGateway(_0x38935a,_0x2ca458,_0x3e803a,_0x5bc88d,_0x314f59);return await _0x19816d['_connect'](),_0x19816d;}['_sendRequest'](_0x48b06b,_0x58a68e,_0xd4d34e){if(!_0x48b06b)throw new _0x1c0920('`serviceName`\x20must\x20be\x20provided.',this);if(this['state']!==WebSocketGateway['STATE_CONNECTED'])throw new _0x1c0920('Not\x20connected.',this);if(!this['_socketAuth']||!this['_socketAuth']['isAuthenticated'])throw new _0x1c0920('Not\x20authenticated.',this);const _0x2fdfe4=new ArrayBuffer(_0xd4d34e['length']+0x2),_0x34f3a9=new Uint8Array(_0x2fdfe4);return _0x34f3a9[0x0]=_0x48b06b,_0x34f3a9[0x1]=parseInt(_0x58a68e),_0x34f3a9['set'](_0xd4d34e,0x2),this['_emit'](0x1,_0x34f3a9);}['_getChannel'](_0x294258,_0x22ab5e){const _0x1aded8=''+_0x294258+_0x22ab5e;return!this['_channels']['has'](_0x1aded8)&&this['_socket']&&this['_channels']['set'](_0x1aded8,new _0x5b0b27(_0x1aded8,this,this['_socket'])),this['_channels']['get'](_0x1aded8);}['_connect'](){return new Promise((_0xdff301,_0xd06404)=>{const _0x4fad0c=this['_setupSocket']();!this['socketId']&&_0x4fad0c['io']['on']('reconnect_error',()=>{this['_debugEvent']('reconnect_error'),this['_reconnectionAttemptError'](_0xd06404);}),_0x4fad0c['once']('connect',async()=>{this['_debugEvent']('once-connect');try{await this['_onConnect'](),_0xdff301();}catch(_0xcaa58e){_0xd06404(_0xcaa58e);}}),_0x4fad0c['connect']();});}['_getPortByProtocol'](_0x3c1848){return['http:','ws:']['includes'](_0x3c1848)?0x50:0x1bb;}['_setupSocket'](){if(this['_socket'])return this['_socket'];const _0x52c1a6=this['_url']['port']||this['_getPortByProtocol'](this['_url']['protocol']),_0x597386=(this['_url']['protocol']||'https:')+'//'+this['_url']['hostname']+':'+_0x52c1a6,_0x13caa2=this['_url']['pathname']['match'](/^\/.*\/ws/)?this['_url']['pathname']['split']('/ws')[0x0]:'',_0x4ddabd=this['_connectionProvider'](_0x597386,{'parser':{'Encoder':Encoder,'Decoder':Decoder},'path':_0x13caa2+'/ws-v2/ws','transports':['websocket'],'timeout':void 0x0!==this['_options']['timeout']?this['_options']['timeout']:0x1388,'reconnection':void 0x0===this['_options']['autoReconnect']||this['_options']['autoReconnect'],'reconnectionDelay':0x3e8,'reconnectionDelayMax':0x1388,'rejectUnauthorized':void 0x0===this['_options']['rejectUnauthorized']||this['_options']['rejectUnauthorized'],'query':{'version':_0x536af9},'agent':this['_options']['agent']??!0x1,'closeOnBeforeunload':!0x1});return this['state']=WEB_SOCKET_GATEWAY_STATES['CONNECTING'],_0x4ddabd['on']('connect',()=>{this['_debugEvent']('connect'),this['socketId']=_0x4ddabd['id'];}),_0x4ddabd['on']('connect_error',_0x1e23c5=>{this['_debugEvent']('connect_error',_0x1e23c5);}),_0x4ddabd['on']('disconnect',()=>{this['_debugEvent']('disconnect'),this['_onDisconnect']();}),_0x4ddabd['io']['on']('reconnect',async()=>{this['_debugEvent']('reconnect'),await this['_onReconnect']();}),_0x4ddabd['io']['on']('reconnect_attempt',_0x169907=>{this['_debugEvent']('reconnect_attempt',_0x169907),this['state']=WEB_SOCKET_GATEWAY_STATES['CONNECTING'],this['_connectionAttempt']=_0x169907;}),_0x4ddabd['on']('unauthorized',_0xeae691=>{this['_debugEvent']('unauthorized'),this['_onUnauthorized'](_0xeae691);}),_0x4ddabd['on']('authenticationRequest',async _0x417fb9=>{this['_debugEvent']('authenticationRequest',_0x417fb9['attempt']),await this['_onReconnect']();}),this['_socket']=_0x4ddabd,_0x4ddabd;}['_emit'](_0x14955a,_0x31b1fa){const _0x27b9af=this['_socket'];return this['_requestsManager']['send'](_0x2737f3=>{_0x27b9af['emit'](_0x14955a,_0x31b1fa,(_0x22eb3f,_0x5c9fca)=>{if(_0x22eb3f)return _0x2737f3['error'](_0xef3092['fromPublicError'](_0x22eb3f));_0x2737f3['response'](_0x5c9fca);});},this['_options']['requestTimeout']);}['_addAuthData'](_0x4fca4e,_0x23a164){this['_socketAuth']={'environmentId':_0x4fca4e,'userId':_0x23a164,'isAuthenticated':!0x0};}['_removeAuthData'](){this['_socketAuth']=void 0x0;}async['_onConnect'](){await this['_authenticate'](this['_token']['value']),this['state']=WEB_SOCKET_GATEWAY_STATES['CONNECTED'];const _0x3ed0fe=async(_0x138f80,_0x1e20ce,_0x413975)=>{this['_debugEvent']('token:value:change');try{await this['_authenticate'](_0x413975);}catch(_0x2d9ec6){}};this['_token']['on']('change:value',_0x3ed0fe),this['_socket']['io']['off']('reconnect_error'),this['on']('disconnect',()=>{this['_token']['off']('change:value',_0x3ed0fe);});}async['_onReconnect'](){await this['_token']['refreshToken'](),await this['_onConnect']();}['_onDisconnect'](){this['state']=WEB_SOCKET_GATEWAY_STATES['DISCONNECTED'],this['_connectionAttempt']=0x0,this['fire']('disconnect');for(const _0xa12d54 of this['_channels']['values']())_0xa12d54['remove']();this['_channels']['clear'](),void 0x0===this['_options']['autoReconnect']||this['_options']['autoReconnect']||(this['_socket']=void 0x0);}['_debugEvent'](_0x1e986a,_0x39bf02){if(!this['_isDebugModeEnabled']())return;const _0x3b7c87=void 0x0!==_0x39bf02?',\x20data:\x20'+_0x39bf02:'';console['info'](new Date()['toLocaleString']()+'\x20'+_0x1e986a+_0x3b7c87);}['_reconnectionAttemptError'](_0x2ae602){this['_connectionAttempt']>=0x2&&(this['disconnect'](),_0x2ae602(_0x1c0920['fromPublicError']({'message':'The\x20number\x20of\x20initial\x20connection\x20attempts\x20exceeded.','explanation':'Three\x20initial\x20connection\x20attempts\x20failed.\x20It\x20can\x20be\x20caused\x20by\x20a\x20slow,\x20unstable,\x20missing\x20or\x20blocked\x20Internet\x20connection.','action':'Please\x20verify\x20the\x20stability\x20of\x20your\x20Internet\x20connection\x20and\x20ensure\x20that\x20no\x20antivirus\x20or\x20firewall\x20software\x20blocks\x20the\x20Web\x20Socket\x20protocol\x20connections.'})));}['_onUnauthorized']({error:_0x4b921e}){this['_removeAuthData'](),this['fire']('error',_0xef3092['fromPublicError'](_0x4b921e));}async['_authenticate'](_0x49dd4e){try{this['_debugEvent']('authenticate:start');const _0x92a802=await this['_emit'](0x2,{'token':_0x49dd4e});this['_debugEvent']('authenticate:success','envId:\x20'+_0x92a802['environmentId']+',\x20userId:\x20'+_0x92a802['userId']),this['_addAuthData'](_0x92a802['environmentId'],_0x92a802['userId']);}catch(_0x2d5155){throw this['_debugEvent']('authenticate:error',_0x2d5155['message']),this['_removeAuthData'](),_0x2d5155;}}['_isDebugModeEnabled'](){if(!global['window']['localStorage'])return!0x1;return'true'===(global['window']['localStorage']['getItem']('csClientDebugMode')??'false')['toLowerCase']();}}export default WebSocketGateway;