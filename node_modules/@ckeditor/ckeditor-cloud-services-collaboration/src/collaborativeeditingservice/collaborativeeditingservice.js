/*
 *             Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
import{v4 as _0xf28218}from'uuid';import{EmitterMixin}from'ckeditor5/src/utils.js';import _0x1d9184 from'./../messagescompressor.js';import _0x555b56 from'./../sessions/sessions.js';import _0x32f3f9 from'./messages/collaborativeeditingconnectmessage.js';import _0x408367 from'./messages/collaborativeeditingupdatemessage.js';import _0x280d59 from'./messages/collaborativeeditingreconnectmessage.js';import _0x3dbea1 from'./responses/collaborativeeditingresponse.js';import _0x14e6b6 from'./responses/collaborativeeditingconnectresponse.js';import _0x2445aa from'./../websocketgateway/websocketgateway.js';import _0x5b5e37 from'../ckeditorcloudserviceserror.js';import _0x37834b from'../errors/ServiceNotConnectedError.js';import _0x17aea7 from'./responses/getdocumentdetailsresponse.js';import _0x5ac1cf from'./messages/getdocumentdetailsmessage.js';export const _SERVICE=0x1;export default class extends/* #__PURE__ -- @preserve */
EmitterMixin(){static ['_SERVICE']=0x1;['_bundleVersion'];['_id'];['_isConnected'];['_wsGateway'];['_channel'];['_connectedSessions'];constructor(_0x2c719b,_0x1989a9){if(super(),!_0x2c719b)throw new TypeError('Param\x20\x22bundleVersion\x22\x20must\x20be\x20provided.');this['_id']=_0x1989a9??_0xf28218(),this['_isConnected']=!0x1,this['_bundleVersion']=_0x2c719b;}['getId'](){return this['_id'];}['isConnected'](){return this['_isConnected'];}['connect'](_0x37cb06,_0x355f6b={'buffers':[],'types':[]},_0x453b92){const _0x1a6c59=new _0x32f3f9(this['getId'](),_0x355f6b['buffers'],_0x355f6b['types'],this['_bundleVersion'],_0x453b92);return this['_connect'](_0x37cb06,_0x1a6c59);}['reconnect'](_0xdead48,_0x2795b5){if(this['isConnected']())throw new _0x5b5e37('Cannot\x20reconnect\x20to\x20already\x20connected\x20service.',_0xdead48);return this['_connect'](_0xdead48,new _0x280d59(this['getId'](),_0x2795b5,this['_bundleVersion']));}['disconnect'](){this['_isConnected']&&(this['_isConnected']=!0x1,this['_wsGateway']&&(this['stopListening'](this['_wsGateway']),this['_wsGateway']=void 0x0),this['_channel']&&(this['stopListening'](this['_channel']),this['_channel']=void 0x0),this['_connectedSessions']&&(this['_connectedSessions']['disconnect'](),this['_connectedSessions']=void 0x0),this['fire']('disconnected'),this['stopListening']());}async['getDocumentDetails'](){const _0x33437c=new _0x5ac1cf(this['getId']());if(!this['_wsGateway'])throw new _0x37834b('Collaborative\x20Editing',this);const _0x3ed84e=await this['_wsGateway']['_sendRequest'](0x1,_0x5ac1cf['TYPE'],_0x1d9184['encode'](_0x33437c));return _0x1d9184['decode'](_0x3ed84e,_0x17aea7);}async['sendOperations'](_0x2ec795,_0x229454,_0x9c9ca6){if(!_0x2ec795?.['types']?.['length'])throw new _0x5b5e37('Cannot\x20send\x20empty\x20update.',this['_wsGateway']);const _0x3b21c7='number'==typeof _0x229454?_0x229454:parseInt(_0x229454);if(!Number['isInteger'](_0x3b21c7)||_0x3b21c7<0x0)throw new _0x5b5e37('Base\x20version\x20not\x20provided.',this['_wsGateway']);const _0x10e816=new _0x408367(this['getId'](),_0x2ec795['buffers'],_0x2ec795['types'],_0x3b21c7,[],_0x9c9ca6);if(!this['_wsGateway']||!this['_isConnected'])throw new _0x37834b('Collaborative\x20Editing',this);const _0x3cbd02=await this['_wsGateway']['_sendRequest'](0x1,_0x408367['TYPE'],_0x1d9184['encode'](_0x10e816));return _0x1d9184['decode'](_0x3cbd02,_0x3dbea1);}async['getConnectedSessions'](){if(!this['_isConnected'])throw new _0x37834b('Collaborative\x20Editing',this);return this['_connectedSessions']||(this['_connectedSessions']=await _0x555b56['getConnectedSessions'](this['_wsGateway'],this['_id'],0x1)),this['_connectedSessions'];}static['getConnectedSessions'](_0x5a86f4,_0x37c7a5){return _0x555b56['getConnectedSessions'](_0x5a86f4,_0x37c7a5,0x1);}async['_connect'](_0x62a81,_0x26104b){if(this['isConnected']())return;if(_0x62a81['state']!==_0x2445aa['STATE_CONNECTED'])throw new _0x5b5e37('WebSocket\x20Gateway\x20is\x20not\x20connected.',_0x62a81);this['_wsGateway']=_0x62a81,this['stopListening'](_0x62a81,'change:state');const _0x1454e9=await _0x62a81['_sendRequest'](0x1,_0x26104b['constructor']['TYPE'],_0x1d9184['encode'](_0x26104b)),_0x1e0cba=_0x1d9184['decode'](_0x1454e9,_0x14e6b6);return this['listenTo'](_0x62a81,'change:state',(_0x46ae6c,_0x144047,_0x1f2350)=>this['_onWsGatewayStateChange'](_0x1f2350),{'priority':_0x2445aa['_CHANGE_STATE_EVENT_PRIORITY']}),this['_connectToChannel'](_0x62a81,_0x1e0cba['channel']),this['_isConnected']=!0x0,this['fire']('connected'),_0x1e0cba;}['_connectToChannel'](_0x56f8e6,_0x1cdeb3){this['_channel']=_0x56f8e6['_getChannel'](0x1,_0x1cdeb3),this['listenTo'](this['_channel'],this['_channel']['getEventName'](_0x408367['TYPE']),(_0x47c1e9,_0x520880)=>{const _0x6ed2d3=_0x1d9184['decode'](_0x520880,_0x408367);this['fire']('operationsReceived',_0x6ed2d3['baseVersion'],_0x6ed2d3['data'],_0x6ed2d3['metadata']);});}['_onWsGatewayStateChange'](_0x46d909){_0x46d909===_0x2445aa['STATE_DISCONNECTED']&&this['disconnect']();}}