/*
 *             Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
import{Collection}from'ckeditor5/src/utils.js';import _0x4d4224 from'./../users/user.js';import _0x240f80 from'./../websocketgateway/websocketgateway.js';import _0x52bf15 from'./responses/sessionsconnectresponse.js';import _0x387c44 from'./messages/sessionsconnectmessage.js';import _0x29e536 from'./messages/socketconnectmessage.js';import _0x2f1c40 from'./messages/socketdisconnectmessage.js';import _0x4e298b from'./../messagescompressor.js';export const _SERVICE=0x3;export default class extends Collection{['_id'];['_sessionType'];['_handlers']=new Map();['_channel'];['_wsGateway'];['_connected'];['_eventsQueue']=[];['_isRunning']=!0x1;constructor(_0x2f7e42,_0x2f6d60){super({'idProperty':'id'}),this['_id']=_0x2f7e42,this['_sessionType']=_0x2f6d60;}async['connect'](_0x2e3315){this['_wsGateway']=_0x2e3315,this['stopListening'](_0x2e3315,'change:state');const _0x3b48f2=new _0x387c44(this['_id'],this['_sessionType']);let _0x4c0cbf;try{const _0x14f292=await this['_wsGateway']['_sendRequest'](0x3,_0x387c44['TYPE'],_0x4e298b['encode'](_0x3b48f2));_0x4c0cbf=_0x4e298b['decode'](_0x14f292,_0x52bf15);}catch(_0x435560){_0x4c0cbf=new _0x52bf15(this['_id'],[]);}this['_connectToChannel'](this['_wsGateway'],_0x4c0cbf['channel'],this['_sessionType']);const _0x4e9dce=await async function(_0x450ff8,_0x12fc42){const _0x3a1f4e=_0x12fc42['map'](_0x2ec693=>_0x2ec693['userId']),_0x270b05=_0x3a1f4e['length']?await _0x4d4224['getMany'](_0x450ff8,_0x3a1f4e):[];return _0x12fc42['map'](_0x216c03=>{const _0x4254d5={'id':_0x216c03['id'],'role':_0x216c03['role'],'permissions':_0x216c03['permissions']};return _0x4254d5['user']=_0x216c03['userId']&&_0x270b05['find'](_0x11204c=>_0x11204c['id']===_0x216c03['userId'])||new _0x4d4224(),_0x4254d5;});}(this['_wsGateway'],_0x4c0cbf['sockets']);for(const _0x2ebbf5 of _0x4e9dce)super['add'](_0x2ebbf5);this['_connected']=!0x0,this['fire']('connected'),this['listenTo'](this['_wsGateway'],'change:state',(_0x3d3602,_0x2b0c0a,_0x485190)=>this['_onWsGatewayStateChange'](_0x485190),{'priority':_0x240f80['_CHANGE_STATE_EVENT_PRIORITY']}),await this['_runQueue']();}['disconnect'](_0x13375c=!0x0){if(this['_connected']){for(this['_connected']=!0x1,this['_eventsQueue']=[];this['length'];)super['remove'](0x0);this['_channel']&&(this['stopListening'](this['_channel']),this['_channel']=void 0x0),this['_wsGateway']&&_0x13375c&&(this['stopListening'](this['_wsGateway']),this['_wsGateway']=void 0x0),this['fire']('disconnected'),_0x13375c&&this['stopListening']();}}['add'](_0x3a8683,_0x3fe5b2){throw new TypeError('The\x20collection\x20is\x20read-only.');}['remove'](_0x1fd62d){throw new TypeError('The\x20collection\x20is\x20read-only.');}['_connectToChannel'](_0x407f1a,_0x5a9862,_0x4d0764){this['_channel']=_0x407f1a['_getChannel'](_0x4d0764,_0x5a9862),this['_channel']&&(this['_addHandler'](this['_channel'],_0x29e536['TYPE'],async _0x1b467f=>{const _0x187a0b=_0x4e298b['decode'](_0x1b467f,_0x29e536);if(-0x1===this['getIndex'](_0x187a0b['id'])){const _0x44998b={'id':_0x187a0b['id'],'role':_0x187a0b['role'],'permissions':_0x187a0b['permissions']};_0x187a0b['userId']&&(_0x44998b['user']=await _0x4d4224['get'](_0x407f1a,_0x187a0b['userId'])),super['add'](_0x44998b);}}),this['_addHandler'](this['_channel'],_0x2f1c40['TYPE'],_0x56d0bb=>{const _0x115987=_0x4e298b['decode'](_0x56d0bb,_0x2f1c40);-0x1!==this['getIndex'](_0x115987['id'])&&super['remove'](_0x115987['id']);}));}async['_onWsGatewayStateChange'](_0x4e9527){_0x4e9527===_0x240f80['STATE_DISCONNECTED']&&this['disconnect'](!0x1),_0x4e9527===_0x240f80['STATE_CONNECTED']&&await this['connect'](this['_wsGateway']);}async['_runQueue'](){if(this['_isRunning']||!this['_connected'])return;let _0x5afad6;for(this['_isRunning']=!0x0;_0x5afad6=this['_eventsQueue']['shift']();){const _0x2db066=this['_handlers']['get'](_0x5afad6['eventName']);_0x2db066&&await _0x2db066(_0x5afad6['data']);}this['_isRunning']=!0x1;}['_addHandler'](_0x2ffe79,_0x547741,_0x20ed70){const _0x7119da=_0x2ffe79['getEventName'](_0x547741,!0x0);this['listenTo'](_0x2ffe79,_0x7119da,async(_0x587f91,_0x58ffae)=>{const _0x51dc0b=_0x587f91['name'];this['_eventsQueue']['push']({'eventName':_0x51dc0b,'data':_0x58ffae}),await this['_runQueue']();}),this['_handlers']['set'](_0x7119da,_0x20ed70);}}