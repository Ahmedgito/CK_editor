/*
 *             Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
import{global as _0x455f0d,ObservableMixin as _0x32a2bc}from'ckeditor5/src/utils.js';import{DialogViewPosition as _0x4f6f13}from'ckeditor5/src/ui.js';import{IconUploadcareImageEdit as _0x53bccf}from'ckeditor5/src/icons.js';import{UploadcareImageEditFormView as _0x4e6c70}from'./uploadcareimageeditformview.js';import{UploadUtils as _0x5ba7de}from'../../utils/uploadutils.js';import{getImageUrls as _0x1c96d6,getImageDimension as _0x217787}from'../../utils/editingutils.js';import{isAncestor as _0x3d2e46}from'../../utils/isancestor.js';export class UploadcareImageEditController extends/* #__PURE__ -- @preserve */
_0x32a2bc(){['_editor'];['_dialog'];['_imageElement'];['_imageCache'];['_controller'];['_attributes'];constructor(_0xc2835f,_0x10d53e,_0x52bb7c){super(),this['_editor']=_0xc2835f,this['_dialog']=_0x10d53e,this['_imageElement']=_0x52bb7c,this['_imageCache']=this['_editor']['plugins']['get']('UploadcareImageEditUI')['imageCache'],this['_attributes']=this['_editor']['config']['get']('uploadcare.editor')||{},this['set']({'isActive':!0x0,'imageStatus':'ready','imageErrorType':null,'imageId':null,'imageSrc':null,'imageDimension':null,'imageUploadProgress':null}),this['_prepareImage'](),this['_showDialog']();}['destroy'](){this['isActive']=!0x1,this['stopListening'](),this['stopDelegating'](),'uploading'===this['imageStatus']&&this['_controller']&&this['_controller']['abort']();}async['_prepareImage'](){const _0x50fdbf=this['_imageElement'],_0x35dcfd=_0x50fdbf['getAttribute']('uploadcareImageId'),_0xe60aee=_0x50fdbf['getAttribute']('src');if(_0x35dcfd)await this['_loadImageInfo'](_0x35dcfd,_0xe60aee);else{if(this['_imageCache']['has'](_0xe60aee)){const _0x1963db=this['_imageCache']['get'](_0xe60aee);this['imageStatus']='ready',this['imageErrorType']=null,this['imageSrc']=_0x1963db['url'],this['imageDimension']=_0x1963db['dimension'],this['imageId']=_0x1963db['id'];}else this['imageStatus']='uploading',this['imageUploadProgress']=0x0,this['_controller']=new AbortController(),await this['_uploadImage'](this['_imageElement'],this['_controller']);}}['_showDialog'](){const {locale:_0x3f6028}=this['_editor'],t=_0x3f6028['t'],_0x57a23a=new _0x4e6c70(_0x3f6028,this['imageStatus'],this['_attributes']);_0x57a23a['bind']('status')['to'](this,'imageStatus'),_0x57a23a['_loadingView']['bind']('imageUploadProgress')['to'](this,'imageUploadProgress'),_0x57a23a['_editingView']['bind']('imageSrc')['to'](this,'imageSrc'),_0x57a23a['_errorView']['bind']('errorType')['to'](this,'imageErrorType'),this['_addEditViewListeners'](_0x57a23a,this['_imageElement']),this['_dialog']['show']({'id':'uploadcareImageEdit','icon':_0x53bccf,'title':t({'id':'Edit\x20Image\x20(Uploadcare)','string':'Edit\x20image'}),'content':_0x57a23a,'position':_0x4f6f13['EDITOR_TOP_CENTER'],'isModal':!0x0,'onShow':()=>{_0x57a23a['focus']();},'onHide':()=>{_0x57a23a['destroy'](),this['destroy']();},'keystrokeHandlerOptions':{'filter':_0x13cac9=>!_0x3d2e46(_0x13cac9,_0x57a23a['element'])}});}['_loadImageInfo'](_0x5491a2,_0xde80bc){return _0x5ba7de['getInfo'](_0x5491a2,{'publicKey':this['_editor']['config']['get']('uploadcare.pubkey'),'baseURL':this['_editor']['config']['get']('uploadcare.uploader.baseUrl')})['then'](_0x393d94=>{const {width:_0x50bd74,height:_0x4c13a6}=_0x393d94['imageInfo'];this['imageStatus']='ready',this['imageErrorType']=null,this['imageSrc']=_0xde80bc,this['imageDimension']={'width':_0x50bd74,'height':_0x4c13a6},this['imageId']=_0x5491a2;})['catch'](_0x1e9bd0=>{this['imageStatus']='error',this['imageErrorType']='FileNotFoundError'===_0x1e9bd0['code']?'NotFound':'Network',this['imageSrc']=null,this['imageDimension']=null,this['imageId']=null,this['imageUploadProgress']=null;});}['_uploadImage'](_0x59b06f,_0x488727){return this['_getImageAsFile'](_0x59b06f)['then'](_0x2ad8bb=>_0x5ba7de['upload']({'publicKey':this['_editor']['config']['get']('uploadcare.pubkey'),'baseURL':this['_editor']['config']['get']('uploadcare.uploader.baseUrl'),'baseCDN':this['_editor']['config']['get']('uploadcare.uploader.cdnCname'),'signal':_0x488727['signal'],'file':_0x2ad8bb,'onProgress':_0x29c854=>{_0x29c854&&_0x29c854['isComputable']&&(this['imageUploadProgress']=Math['ceil'](0x64*_0x29c854['value']));}}))['then'](_0x25d7f5=>{const {width:_0x17c63d,height:_0x193e0b}=_0x25d7f5['imageInfo'];this['imageStatus']='ready',this['imageErrorType']=null,this['imageSrc']=_0x25d7f5['cdnUrl'],this['imageDimension']={'width':_0x17c63d,'height':_0x193e0b},this['imageId']=_0x25d7f5['uuid'],this['imageUploadProgress']=null;const _0x210066=_0x59b06f['getAttribute']('src');this['_imageCache']['set'](_0x210066,{'id':_0x25d7f5['uuid'],'url':_0x25d7f5['cdnUrl'],'dimension':this['imageDimension']});})['catch'](_0x4057e8=>{this['imageStatus']='error',this['imageErrorType']='FileNotFoundError'===_0x4057e8['code']?'NotFound':'Network',this['imageSrc']=null,this['imageDimension']=null,this['imageId']=null,this['imageUploadProgress']=null;});}['_addEditViewListeners'](_0xee081c,_0x3a8717){_0xee081c['on']('apply',(_0x588d56,_0x4cb1e2)=>{this['_replaceImage'](_0x3a8717,_0x4cb1e2['imageSrc'],this['imageId']),this['_dialog']['hide']();}),_0xee081c['on']('retry',()=>{this['imageStatus']='uploading',this['imageUploadProgress']=0x0,this['_controller']=new AbortController(),this['_uploadImage'](this['_imageElement'],this['_controller']);}),_0xee081c['on']('cancel',()=>{this['_dialog']['hide']();});}['_replaceImage'](_0xb5ff33,_0x59a48b,_0xd1237b){const _0x486f49=this['_editor'],{width:_0x2bf41b,height:_0x3a14df}=_0x217787(_0x59a48b,this['imageDimension']['width'],this['imageDimension']['height']),{imageFallbackUrl:_0xbf234c,imageSources:_0x4546c8}=_0x1c96d6(_0x59a48b,_0x2bf41b);_0x486f49['model']['change'](_0x511e8c=>{if('$graveyard'===_0xb5ff33['root']['rootName']){_0x486f49['execute']('insertImage',{'imageType':_0xb5ff33['is']('element','imageInline')?'imageInline':null,'source':{...Object['fromEntries'](_0xb5ff33['getAttributes']()),'uploadcareImageId':_0xd1237b,'src':_0xbf234c,'sources':_0x4546c8,'width':_0x2bf41b,'height':_0x3a14df}});const _0x4fbea4=_0xb5ff33['getChildren']();_0xb5ff33=_0x486f49['model']['document']['selection']['getSelectedElement']();for(const _0x2a59b7 of _0x4fbea4)_0x511e8c['append'](_0x511e8c['cloneElement'](_0x2a59b7),_0xb5ff33);}else _0x511e8c['setSelection'](_0xb5ff33,'on'),_0x486f49['execute']('uploadcareImageReplace',{...Object['fromEntries'](_0xb5ff33['getAttributes']()),'uploadcareImageId':_0xd1237b,'src':_0xbf234c,'sources':_0x4546c8,'width':_0x2bf41b,'height':_0x3a14df},_0xb5ff33);_0x511e8c['setSelection'](_0xb5ff33,'on');});}async['_getImageAsFile'](_0x5d21bf){const _0x3a1deb=_0x455f0d['window'],_0x36c0ba=_0x455f0d['document']['location']['href'],_0x3d566c=new _0x3a1deb['URL'](_0x5d21bf['getAttribute']('src'),_0x36c0ba);if('data:'===_0x3d566c['protocol']){const _0x2fec95=_0x3d566c['href']['split'](','),_0x3fcff8=_0x2fec95[0x0]['match'](/:(.*?);/)[0x1],_0x433333=_0x3fcff8['split']('/')[0x1],_0x2f9f8f=_0x3a1deb['atob'](_0x2fec95[_0x2fec95['length']-0x1]);let _0x3d15f6=_0x2f9f8f['length'];const _0x364981=new _0x3a1deb['Uint8Array'](_0x3d15f6);for(;_0x3d15f6--;)_0x364981[_0x3d15f6]=_0x2f9f8f['charCodeAt'](_0x3d15f6);return new _0x3a1deb['File']([_0x364981],'image.'+_0x433333,{'type':_0x3fcff8});}const _0xb02eff=_0x3d566c['href']['split']('/'),_0x49c831=_0xb02eff[_0xb02eff['length']-0x1],_0xd400c8=_0x49c831['split']('.')[0x1];return _0x3a1deb['fetch'](_0x3d566c['href'])['then'](_0x7e1cce=>_0x7e1cce['clone']()['blob']())['then'](_0x162514=>new _0x3a1deb['File']([_0x162514],_0x49c831,{'type':'image/'+_0xd400c8}));}}